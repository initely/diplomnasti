<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Главная страница</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link href="/pages/subjects_page/styles.css" rel="stylesheet">
    <style>
        html,
        body {
            height: 100%;
        }

        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container.mt-5 {
            flex: 1 0 auto;
            min-height: 60vh;
            display: flex;
            align-items: center;
        }

        .footer {
            background: #f3f0ff;
            color: #7e57c2;
            font-size: 1.1rem;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .info-block {
            background: #e8e6ff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(126, 87, 194, 0.07);
            margin-bottom: 1.5rem;
            font-size: 1.7rem;
            line-height: 1.7;
            padding: 3rem 2.5rem;
        }

        .ellipse-img-only {
            width: 440px;
            height: 500px;
            object-fit: cover;
        }
    </style>
</head>

<body>
    {% set page_title = "Главная страница" %}
    {% set additional_content %}
    <div class="navbar-nav ms-auto">
        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">Вход</a>
        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#registerModal">Регистрация</a>
    </div>
    {% endset %}
    {% include "components/page_header.html" %}

    <!-- Основной контент -->
    <div class="container mt-5">
        <div class="row align-items-center">
            <div class="col-md-5 mb-4 mb-md-0 d-flex flex-column justify-content-center align-items-stretch gap-4">
                <div class="info-block p-5 rounded shadow-sm bg-white h-100 d-flex align-items-center">
                    <p class="mb-0">Определение будущей профессии это важный шаг, о котором нужно задуматься как можно
                        раньше и мы в этом поможем</p>
                </div>
            </div>
            <div class="col-md-5 mb-4 mb-md-0 d-flex flex-column justify-content-center align-items-stretch gap-4">
                <div class="info-block p-5 rounded shadow-sm bg-white h-100 d-flex align-items-center">
                    <p class="mb-0">У нас ты сможешь пройти тесты на определение твоих уклонов в интересном формате, без
                        нудных философских тестов</p>
                </div>
            </div>
            <div class="col-md-2 d-flex justify-content-center align-items-center">
                <img src="/icons/main_person.png" alt="Фото" class="ellipse-img-only">
            </div>
        </div>
    </div>

    <!-- Подвал -->
    <footer class="footer mt-5 py-4 bg-light text-center">
        <div class="container">
            <span class="text-muted">Контакты: <a href="#"
                    onclick="copyEmail(event); return false;">anastasia.kukaeva@yandex.ru</a> | <a
                    href="https://t.me/anasgrei" target="_blank">@anasgrei</a></span>
        </div>
    </footer>

    <!-- Модальное окно входа -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Вход в систему</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger d-none" id="loginError"></div>
                    <form id="loginForm">
                        <div class="mb-4">
                            <input type="email" name="email" class="form-control" placeholder="Email" required>
                        </div>
                        <div class="mb-4">
                            <input type="password" name="password" class="form-control" placeholder="Пароль" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Вход</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно регистрации -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Регистрация родителя</h5>

                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <p>При прихождении самостоятельной регистрации на сайте, вы не привязываетесь к конкретной школе</p>
                <div class="modal-body">
                    <div class="alert alert-danger d-none" id="registerError"></div>
                    <form id="registerForm">
                        <input type="hidden" name="role" value="parent">
                        <div class="mb-4">
                            <input type="email" name="email" class="form-control" placeholder="Email" required>
                        </div>
                        <div class="mb-4">
                            <input type="password" name="password" class="form-control" placeholder="Пароль" required>
                        </div>
                        <div class="mb-4">
                            <input type="text" name="full_name" class="form-control" placeholder="ФИО" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Зарегистрироваться</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const errorElement = document.getElementById('loginError');

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(Object.fromEntries(formData))
                });

                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    window.location.href = data.redirect || '/me';
                } else {
                    let errorMessage;
                    if (Array.isArray(data.detail)) {
                        errorMessage = data.detail.map(err => {
                            if (err.loc[1] === 'password') {
                                return 'Пароль должен содержать минимум 6 символов';
                            }
                            if (err.loc[1] === 'email') {
                                return 'Неверный формат email';
                            }
                            return err.msg;
                        }).join('. ');
                    } else {
                        errorMessage = data.detail;
                    }

                    errorElement.textContent = errorMessage || 'Произошла ошибка при входе';
                    errorElement.classList.remove('d-none');
                }
            } catch (error) {
                console.error('Error:', error);
                errorElement.textContent = 'Произошла ошибка при подключении к серверу';
                errorElement.classList.remove('d-none');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const errorElement = document.getElementById('registerError');

            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(Object.fromEntries(formData))
                });

                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
                    modal.hide();
                    alert('Регистрация прошла успешно!');
                    this.reset();
                    window.location.href = '/';
                } else {
                    let errorMessage;
                    if (Array.isArray(data.detail)) {
                        errorMessage = data.detail.map(err => {
                            const fieldErrors = {
                                'password': 'Пароль должен содержать минимум 6 символов',
                                'email': 'Неверный формат email',
                                'full_name': 'Укажите ФИО'
                            };
                            return fieldErrors[err.loc[1]] || err.msg;
                        }).join('. ');
                    } else {
                        errorMessage = data.detail;
                    }

                    errorElement.textContent = errorMessage || 'Произошла ошибка при регистрации';
                    errorElement.classList.remove('d-none');
                }
            } catch (error) {
                console.error('Error:', error);
                errorElement.textContent = 'Произошла ошибка при подключении к серверу';
                errorElement.classList.remove('d-none');
            }
        });

        // Скрываем сообщения об ошибках при открытии модальных окон
        document.getElementById('loginModal').addEventListener('show.bs.modal', function () {
            document.getElementById('loginError').classList.add('d-none');
        });

        document.getElementById('registerModal').addEventListener('show.bs.modal', function () {
            document.getElementById('registerError').classList.add('d-none');
            document.getElementById('registerForm').reset();
        });

        function copyEmail(event) {
            event.preventDefault();
            const email = 'anastasia.kukaeva@yandex.ru';
            const textArea = document.createElement('textarea');
            textArea.value = email;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('Email скопирован в буфер обмена!');
            } catch (err) {
                console.error('Ошибка при копировании: ', err);
            }
            document.body.removeChild(textArea);
        }
    </script>
</body>

</html>